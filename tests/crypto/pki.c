/*
 * Copyright 2017-2020 AVSystem <avsystem@avsystem.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <avs_commons_posix_init.h> // for struct stat::st_mtim

#include <inttypes.h>

#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

#include <avsystem/commons/avs_base64.h>
#include <avsystem/commons/avs_crypto_pki.h>
#include <avsystem/commons/avs_stream_membuf.h>
#include <avsystem/commons/avs_unit_test.h>
#include <avsystem/commons/avs_utils.h>

#include "pki.h"

#include "src/crypto/avs_crypto_utils.h"

AVS_UNIT_TEST(avs_crypto_pki_ec, test_ec_gen) {
    avs_crypto_prng_ctx_t *prng_ctx = avs_crypto_prng_new(NULL, NULL);
    AVS_UNIT_ASSERT_NOT_NULL(prng_ctx);

    uint8_t secret_key[256];
    size_t secret_key_size = sizeof(secret_key);
    AVS_UNIT_ASSERT_SUCCESS(
            avs_crypto_pki_ec_gen(prng_ctx, AVS_CRYPTO_PKI_ECP_GROUP_SECP256R1,
                                  secret_key, &secret_key_size));

    avs_crypto_prng_free(&prng_ctx);

    // The resulting data shall look like this:
    //
    // SEQUENCE (4 elem)                                     30 77
    //   INTEGER 1                                           02 01 01
    //   OCTET STRING (32 byte) [EC parameters]              04 20 [32bytesData]
    //   [0] (1 elem)                                        A0 0A
    //     OBJECT IDENTIFIER 1.2.840.10045.3.1.7 prime256v1  06 08 2A 86 48 CE
    //                                                             3D 03 01 07
    //   [1] (1 elem)                                        A1 44
    //     BIT STRING (520 bit) [private key]                03 42 [66bytesData]
    //
    // (121 bytes total)

    AVS_UNIT_ASSERT_EQUAL(secret_key_size, 121);
    AVS_UNIT_ASSERT_EQUAL_BYTES(secret_key, "\x30\x77\x02\x01\x01\x04\x20");
    AVS_UNIT_ASSERT_EQUAL_BYTES(
            &secret_key[39],
            "\xA0\x0A\x06\x08\x2A\x86\x48\xCE\x3D\x03\x01\x07\xA1\x44\x03\x42");
}

AVS_UNIT_TEST(avs_crypto_pki_ec, test_csr_create) {
#define TEST_CN "avs_crypto_pki_ec_test_csr_create"
    avs_crypto_prng_ctx_t *prng_ctx = avs_crypto_prng_new(NULL, NULL);
    AVS_UNIT_ASSERT_NOT_NULL(prng_ctx);

    uint8_t secret_key[256];
    size_t secret_key_size = sizeof(secret_key);
    AVS_UNIT_ASSERT_SUCCESS(
            avs_crypto_pki_ec_gen(prng_ctx, AVS_CRYPTO_PKI_ECP_GROUP_SECP256R1,
                                  secret_key, &secret_key_size));

    uint8_t csr[512];
    size_t csr_size = sizeof(csr);

    avs_crypto_client_key_info_t key_info =
            avs_crypto_client_key_info_from_buffer(secret_key, secret_key_size,
                                                   NULL);
    AVS_UNIT_ASSERT_SUCCESS(avs_crypto_pki_csr_create(
            prng_ctx, &key_info, "SHA256",
            AVS_CRYPTO_PKI_X509_NAME({ AVS_CRYPTO_PKI_X509_NAME_CN, TEST_CN }),
            csr, &csr_size));

    avs_crypto_prng_free(&prng_ctx);

    // The resulting data shall look like this:
    //
    // SEQUENCE (3 elem)                                         30 81 ??
    //   SEQUENCE (4 elem)                                       30 81 8E
    //     INTEGER 0                                             02 01 00
    //     SEQUENCE (1 elem)                                     30 2C
    //       SET (1 elem)                                        31 2A
    //         SEQUENCE (2 elem)                                 30 28
    //           OBJECT IDENTIFIER 2.5.4.3 commonName            06 03 55 04 03
    //           UTF8String avs_crypto_pki_ec_test_csr_create    0C 21 [string]
    //     SEQUENCE (2 elem)                                     30 59
    //       SEQUENCE (2 elem)                                   30 13
    //         OBJECT IDENTIFIER 1.2.840.10045.2.1 ecPublicKey   06 07 2A 86 48
    //                                                           CE 3D 02 01
    //         OBJECT IDENTIFIER 1.2.840.10045.3.1.7 prime256v1  06 08 2A 86 48
    //                                                           CE 3D 03 01 07
    //       BIT STRING (520 bit)                                03 42 [66bytes]
    //     [0] (0 elem)                                          A0 00
    //   SEQUENCE (1-2 elem)                                     30 (0A or 0C)
    //     OBJECT IDENTIFIER 1.2.840.10045.4.3.2 ecdsaWithSHA256 06 08 2A 86 48
    //                                                           CE 3D 04 03 02
    //     NULL                                                  05 00 (opt)
    //   BIT STRING (1 elem)                                     03 ?? 00
    //     SEQUENCE (2 elem)                                     30 ??
    //       INTEGER (max 256 bit)                               02 ??
    //       INTEGER (max 256 bit)                               02 ??

    AVS_UNIT_ASSERT_TRUE(csr_size > 169);
    AVS_UNIT_ASSERT_TRUE(csr_size <= 237);
    AVS_UNIT_ASSERT_EQUAL_BYTES(csr, "\x30\x81");
    AVS_UNIT_ASSERT_EQUAL(csr[2], csr_size - 3);
    AVS_UNIT_ASSERT_EQUAL_BYTES(
            &csr[3], "\x30\x81\x8E\x02\x01\x00\x30\x2C\x31\x2A\x30\x28\x06\x03"
                     "\x55\x04\x03\x0C\x21" TEST_CN
                     "\x30\x59\x30\x13\x06\x07\x2A\x86\x48\xCE\x3D\x02\x01\x06"
                     "\x08\x2A\x86\x48\xCE\x3D\x03\x01\x07\x03\x42");
    AVS_UNIT_ASSERT_EQUAL_BYTES(&csr[146], "\xA0\x00\x30");
    AVS_UNIT_ASSERT_TRUE(csr[149] == 0x0A || csr[149] == 0x0C);
    bool has_additional_null_md = (csr[149] == 0x0C);
    AVS_UNIT_ASSERT_EQUAL_BYTES(&csr[150],
                                "\x06\x08\x2A\x86\x48\xCE\x3D\x04\x03\x02");
    size_t signature_offset;
    if (has_additional_null_md) {
        AVS_UNIT_ASSERT_EQUAL_BYTES(&csr[160], "\x05\x00");
        signature_offset = 162;
    } else {
        signature_offset = 160;
    }
    AVS_UNIT_ASSERT_EQUAL(csr[signature_offset], 0x03);
    AVS_UNIT_ASSERT_EQUAL(csr[signature_offset + 1],
                          csr_size - signature_offset - 2);
    AVS_UNIT_ASSERT_EQUAL_BYTES(&csr[signature_offset + 2], "\x00\x30");
    AVS_UNIT_ASSERT_EQUAL(csr[signature_offset + 4],
                          csr_size - signature_offset - 5);
    AVS_UNIT_ASSERT_EQUAL(csr[signature_offset + 5], 0x02);
    AVS_UNIT_ASSERT_EQUAL(csr[signature_offset + 7 + csr[signature_offset + 6]],
                          0x02);
    AVS_UNIT_ASSERT_EQUAL(
            csr[signature_offset + 6]
                    + csr[signature_offset + 8 + csr[signature_offset + 6]],
            csr_size - signature_offset - 9);
#undef TEST_CN
}

AVS_UNIT_TEST(avs_crypto_pki, avs_crypto_client_cert_expiration_date) {
    static const char CERT_PATH[] = "../certs/client.crt";

    struct stat file_stat;
    AVS_UNIT_ASSERT_SUCCESS(stat(CERT_PATH, &file_stat));
    avs_time_real_t file_mtime = {
        .since_real_epoch = {
            .seconds = file_stat.st_mtim.tv_sec,
            .nanoseconds = (int32_t) file_stat.st_mtim.tv_nsec
        }
    };

    avs_crypto_client_cert_info_t cert_info =
            avs_crypto_client_cert_info_from_file(CERT_PATH);
    avs_time_real_t cert_validity =
            avs_crypto_client_cert_expiration_date(&cert_info);

    AVS_UNIT_ASSERT_TRUE(avs_time_real_valid(cert_validity));
    double cert_relative_validity = avs_time_duration_to_fscalar(
            avs_time_real_diff(cert_validity, file_mtime), AVS_TIME_S);

    // the cert is supposed to be valid for 9999 days since generation
    // test that it is, with up to 30 second difference allowed
    AVS_UNIT_ASSERT_TRUE(cert_relative_validity >= 9999.0 * 86400.0 - 30.0);
    AVS_UNIT_ASSERT_TRUE(cert_relative_validity <= 9999.0 * 86400.0 + 30.0);
}

AVS_UNIT_TEST(avs_crypto_pki_pkcs7, pkcs7_parse_success) {
    // Converted to raw BER bytes and downloaded from:
    // https://raw.githubusercontent.com/openssl/openssl/dd0164e7565bb14fac193aea4c2c37714bf66d56/test/pkcs7.pem
    static const char PKCS7_DATA[] =
            "\x30\x80\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x07\x02\xa0\x80\x30"
            "\x80\x02\x01\x01\x31\x00\x30\x80\x06\x09\x2a\x86\x48\x86\xf7\x0d"
            "\x01\x07\x01\x00\x00\xa0\x80\x30\x82\x04\xf8\x30\x82\x04\x61\xa0"
            "\x03\x02\x01\x02\x02\x10\x68\x64\x85\xfc\x9a\x5b\x4b\x50\xb6\xdb"
            "\x7f\xb2\xad\xcf\x8d\xd4\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d"
            "\x01\x01\x04\x05\x00\x30\x62\x31\x11\x30\x0f\x06\x03\x55\x04\x07"
            "\x13\x08\x49\x6e\x74\x65\x72\x6e\x65\x74\x31\x17\x30\x15\x06\x03"
            "\x55\x04\x0a\x13\x0e\x56\x65\x72\x69\x53\x69\x67\x6e\x2c\x20\x49"
            "\x6e\x63\x2e\x31\x34\x30\x32\x06\x03\x55\x04\x0b\x13\x2b\x56\x65"
            "\x72\x69\x53\x69\x67\x6e\x20\x43\x6c\x61\x73\x73\x20\x31\x20\x43"
            "\x41\x20\x2d\x20\x49\x6e\x64\x69\x76\x69\x64\x75\x61\x6c\x20\x53"
            "\x75\x62\x73\x63\x72\x69\x62\x65\x72\x30\x1e\x17\x0d\x39\x36\x30"
            "\x38\x31\x32\x30\x30\x30\x30\x30\x30\x5a\x17\x0d\x39\x36\x30\x38"
            "\x31\x37\x32\x33\x35\x39\x35\x39\x5a\x30\x82\x01\x20\x31\x11\x30"
            "\x0f\x06\x03\x55\x04\x07\x13\x08\x49\x6e\x74\x65\x72\x6e\x65\x74"
            "\x31\x17\x30\x15\x06\x03\x55\x04\x0a\x13\x0e\x56\x65\x72\x69\x53"
            "\x69\x67\x6e\x2c\x20\x49\x6e\x63\x2e\x31\x34\x30\x32\x06\x03\x55"
            "\x04\x0b\x13\x2b\x56\x65\x72\x69\x53\x69\x67\x6e\x20\x43\x6c\x61"
            "\x73\x73\x20\x31\x20\x43\x41\x20\x2d\x20\x49\x6e\x64\x69\x76\x69"
            "\x64\x75\x61\x6c\x20\x53\x75\x62\x73\x63\x72\x69\x62\x65\x72\x31"
            "\x37\x30\x35\x06\x03\x55\x04\x0b\x13\x2e\x44\x69\x67\x69\x74\x61"
            "\x6c\x20\x49\x44\x20\x43\x6c\x61\x73\x73\x20\x31\x20\x2d\x20\x53"
            "\x4d\x49\x4d\x45\x20\x56\x65\x72\x69\x53\x69\x67\x6e\x2c\x20\x49"
            "\x6e\x63\x2e\x20\x54\x45\x53\x54\x31\x46\x30\x44\x06\x03\x55\x04"
            "\x0b\x13\x3d\x77\x77\x77\x2e\x76\x65\x72\x69\x73\x69\x67\x6e\x2e"
            "\x63\x6f\x6d\x2f\x72\x65\x70\x6f\x73\x69\x74\x6f\x72\x79\x2f\x43"
            "\x50\x53\x20\x49\x6e\x63\x6f\x72\x70\x2e\x20\x62\x79\x20\x52\x65"
            "\x66\x2e\x2c\x4c\x49\x41\x42\x2e\x4c\x54\x44\x28\x63\x29\x39\x36"
            "\x31\x19\x30\x17\x06\x03\x55\x04\x03\x13\x10\x41\x6c\x65\x78\x61"
            "\x6e\x64\x72\x65\x20\x44\x65\x61\x63\x6f\x6e\x31\x20\x30\x1e\x06"
            "\x09\x2a\x86\x48\x86\xf7\x0d\x01\x09\x01\x16\x11\x61\x6c\x65\x78"
            "\x40\x76\x65\x72\x69\x73\x69\x67\x6e\x2e\x63\x6f\x6d\x30\x5b\x30"
            "\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x01\x05\x00\x03\x4a"
            "\x00\x30\x47\x02\x40\x0e\xcb\xbc\x71\x08\x02\x24\x39\xfb\x88\x03"
            "\x62\xf2\x46\x9c\x60\x2a\x50\xce\x46\x5f\x21\xb5\xd5\xd8\x84\x5e"
            "\x62\x04\x65\x31\xd4\x66\x1a\x2b\xa2\x85\xf9\xb2\xbf\x08\x22\x34"
            "\x97\x88\xf6\x39\xf5\x86\x14\x15\x2b\xc0\x6a\x16\xab\x14\xcd\x71"
            "\x68\x13\x7c\xcc\xd1\x02\x03\x01\x00\x01\xa3\x82\x02\x32\x30\x82"
            "\x02\x2e\x30\x09\x06\x03\x55\x1d\x13\x04\x02\x30\x00\x30\x82\x02"
            "\x1f\x06\x03\x55\x1d\x03\x04\x82\x02\x16\x30\x82\x02\x12\x30\x82"
            "\x02\x0e\x30\x82\x02\x0a\x06\x0b\x60\x86\x48\x01\x86\xf8\x45\x01"
            "\x07\x01\x01\x30\x82\x01\xf9\x16\x82\x01\xa7\x54\x68\x69\x73\x20"
            "\x63\x65\x72\x74\x69\x66\x69\x63\x61\x74\x65\x20\x69\x6e\x63\x6f"
            "\x72\x70\x6f\x72\x61\x74\x65\x73\x20\x62\x79\x20\x72\x65\x66\x65"
            "\x72\x65\x6e\x63\x65\x2c\x20\x61\x6e\x64\x20\x69\x74\x73\x20\x75"
            "\x73\x65\x20\x69\x73\x20\x73\x74\x72\x69\x63\x74\x6c\x79\x20\x73"
            "\x75\x62\x6a\x65\x63\x74\x20\x74\x6f\x2c\x20\x74\x68\x65\x20\x56"
            "\x65\x72\x69\x53\x69\x67\x6e\x20\x43\x65\x72\x74\x69\x66\x69\x63"
            "\x61\x74\x69\x6f\x6e\x20\x50\x72\x61\x63\x74\x69\x63\x65\x20\x53"
            "\x74\x61\x74\x65\x6d\x65\x6e\x74\x20\x28\x43\x50\x53\x29\x2c\x20"
            "\x61\x76\x61\x69\x6c\x61\x62\x6c\x65\x20\x61\x74\x3a\x20\x68\x74"
            "\x74\x70\x73\x3a\x2f\x2f\x77\x77\x77\x2e\x76\x65\x72\x69\x73\x69"
            "\x67\x6e\x2e\x63\x6f\x6d\x2f\x43\x50\x53\x3b\x20\x62\x79\x20\x45"
            "\x2d\x6d\x61\x69\x6c\x20\x61\x74\x20\x43\x50\x53\x2d\x72\x65\x71"
            "\x75\x65\x73\x74\x73\x40\x76\x65\x72\x69\x73\x69\x67\x6e\x2e\x63"
            "\x6f\x6d\x3b\x20\x6f\x72\x20\x62\x79\x20\x6d\x61\x69\x6c\x20\x61"
            "\x74\x20\x56\x65\x72\x69\x53\x69\x67\x6e\x2c\x20\x49\x6e\x63\x2e"
            "\x2c\x20\x32\x35\x39\x33\x20\x43\x6f\x61\x73\x74\x20\x41\x76\x65"
            "\x2e\x2c\x20\x4d\x6f\x75\x6e\x74\x61\x69\x6e\x20\x56\x69\x65\x77"
            "\x2c\x20\x43\x41\x20\x39\x34\x30\x34\x33\x20\x55\x53\x41\x20\x54"
            "\x65\x6c\x2e\x20\x2b\x31\x20\x28\x34\x31\x35\x29\x20\x39\x36\x31"
            "\x2d\x38\x38\x33\x30\x20\x43\x6f\x70\x79\x72\x69\x67\x68\x74\x20"
            "\x28\x63\x29\x20\x31\x39\x39\x36\x20\x56\x65\x72\x69\x53\x69\x67"
            "\x6e\x2c\x20\x49\x6e\x63\x2e\x20\x20\x41\x6c\x6c\x20\x52\x69\x67"
            "\x68\x74\x73\x20\x52\x65\x73\x65\x72\x76\x65\x64\x2e\x20\x43\x45"
            "\x52\x54\x41\x49\x4e\x20\x57\x41\x52\x52\x41\x4e\x54\x49\x45\x53"
            "\x20\x44\x49\x53\x43\x4c\x41\x49\x4d\x45\x44\x20\x61\x6e\x64\x20"
            "\x4c\x49\x41\x42\x49\x4c\x49\x54\x59\x20\x4c\x49\x4d\x49\x54\x45"
            "\x44\x2e\xa0\x0e\x06\x0c\x60\x86\x48\x01\x86\xf8\x45\x01\x07\x01"
            "\x01\x01\xa1\x0e\x06\x0c\x60\x86\x48\x01\x86\xf8\x45\x01\x07\x01"
            "\x01\x02\x30\x2c\x30\x2a\x16\x28\x68\x74\x74\x70\x73\x3a\x2f\x2f"
            "\x77\x77\x77\x2e\x76\x65\x72\x69\x73\x69\x67\x6e\x2e\x63\x6f\x6d"
            "\x2f\x72\x65\x70\x6f\x73\x69\x74\x6f\x72\x79\x2f\x43\x50\x53\x20"
            "\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x04\x05\x00\x03"
            "\x81\x81\x00\x22\x99\x63\x06\x43\x0c\x30\xc6\x4f\x9b\xdc\xa0\x0b"
            "\x1e\x54\x96\x5e\xd5\x3b\x2d\x61\xde\xdb\xd0\x84\x1b\xc5\xde\x54"
            "\xd4\xef\xae\xab\x3a\x48\x1a\x93\xec\xea\x04\x34\xe9\x06\xc6\x97"
            "\xdd\xa5\x58\x19\xdd\x0c\x36\x48\xa8\xf1\x0e\xf6\xef\xa5\xf4\x85"
            "\xb2\x5b\x2a\x73\x15\x92\x80\x1f\xe1\x5a\xe6\x95\xb9\x90\xa4\xbd"
            "\x3c\x3f\x75\x81\x86\x3b\x19\x13\x24\x6c\x6f\x0c\x27\xe5\xd4\xf6"
            "\x63\x5f\x87\x4a\x6d\xab\x6c\x96\xc8\xbd\x67\xd1\xe9\x19\x64\xfb"
            "\xb6\xd2\x2d\x47\x02\xaa\x70\x12\xa0\x98\x22\x6f\x2a\x2d\x69\x19"
            "\x61\x03\xd3\x30\x82\x02\x79\x30\x82\x01\xe2\xa0\x03\x02\x01\x02"
            "\x02\x10\x35\x11\xa5\x52\x90\x6f\xe7\xd0\x29\xa4\x40\x19\xd4\x11"
            "\xfc\x3e\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x02\x05"
            "\x00\x30\x5f\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x55\x53"
            "\x31\x17\x30\x15\x06\x03\x55\x04\x0a\x13\x0e\x56\x65\x72\x69\x53"
            "\x69\x67\x6e\x2c\x20\x49\x6e\x63\x2e\x31\x37\x30\x35\x06\x03\x55"
            "\x04\x0b\x13\x2e\x43\x6c\x61\x73\x73\x20\x31\x20\x50\x75\x62\x6c"
            "\x69\x63\x20\x50\x72\x69\x6d\x61\x72\x79\x20\x43\x65\x72\x74\x69"
            "\x66\x69\x63\x61\x74\x69\x6f\x6e\x20\x41\x75\x74\x68\x6f\x72\x69"
            "\x74\x79\x30\x1e\x17\x0d\x39\x36\x30\x36\x32\x37\x30\x30\x30\x30"
            "\x30\x30\x5a\x17\x0d\x39\x37\x30\x36\x32\x37\x32\x33\x35\x39\x35"
            "\x39\x5a\x30\x62\x31\x11\x30\x0f\x06\x03\x55\x04\x07\x13\x08\x49"
            "\x6e\x74\x65\x72\x6e\x65\x74\x31\x17\x30\x15\x06\x03\x55\x04\x0a"
            "\x13\x0e\x56\x65\x72\x69\x53\x69\x67\x6e\x2c\x20\x49\x6e\x63\x2e"
            "\x31\x34\x30\x32\x06\x03\x55\x04\x0b\x13\x2b\x56\x65\x72\x69\x53"
            "\x69\x67\x6e\x20\x43\x6c\x61\x73\x73\x20\x31\x20\x43\x41\x20\x2d"
            "\x20\x49\x6e\x64\x69\x76\x69\x64\x75\x61\x6c\x20\x53\x75\x62\x73"
            "\x63\x72\x69\x62\x65\x72\x30\x81\x9f\x30\x0d\x06\x09\x2a\x86\x48"
            "\x86\xf7\x0d\x01\x01\x01\x05\x00\x03\x81\x8d\x00\x30\x81\x89\x02"
            "\x81\x81\x00\xb6\x14\xa6\xcf\x4d\xd0\x05\x0d\xd8\xca\x23\xd0\x6f"
            "\xaa\xb4\x29\x92\x63\x8e\x2c\xf8\x6f\x96\xd7\x2e\x9d\x76\x4b\x11"
            "\xb1\x36\x8d\x57\xc9\xc3\xfd\x1c\xc6\xba\xfe\x1e\x08\xba\x33\xca"
            "\x95\xea\xbe\xe3\x5b\xcd\x06\xa8\xb7\x79\x1d\x44\x2a\xed\x73\xf2"
            "\xb1\x52\x83\x68\x10\x70\x64\x91\xd7\x3e\x6b\xf9\xf7\x5d\x9d\x14"
            "\x43\x9b\x6e\x97\x45\x98\x81\x47\xd1\x2d\xcb\xdd\xbb\x72\xd7\x4c"
            "\x3f\x71\xaa\xe2\x40\xf2\x54\x39\xbc\x16\xee\xcf\x7c\xec\xba\xdb"
            "\x3f\x6c\x2a\xb3\x16\xb1\x86\x12\x9d\xae\x93\x34\xd5\xb8\xd5\xd0"
            "\xf7\x3e\xa9\x02\x03\x01\x00\x01\xa3\x33\x30\x31\x30\x0f\x06\x03"
            "\x55\x1d\x13\x04\x08\x30\x06\x01\x01\xff\x02\x01\x01\x30\x0b\x06"
            "\x03\x55\x1d\x0f\x04\x04\x03\x02\x01\x06\x30\x11\x06\x09\x60\x86"
            "\x48\x01\x86\xf8\x42\x01\x01\x04\x04\x03\x02\x02\x04\x30\x0d\x06"
            "\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x02\x05\x00\x03\x81\x81\x00"
            "\x29\xe5\xc7\xa0\x19\xa7\x6f\x14\x42\x82\x4d\x23\x33\xd7\xbd\x98"
            "\x3a\x69\x77\x1a\x6c\x8a\x92\x27\x6b\xf2\x7c\x0c\xe1\xc4\x52\xe0"
            "\xf8\x9c\xe3\x40\xaf\x8f\xb1\x3a\x0e\xf7\x48\x19\x74\xdb\xa9\xfb"
            "\x06\x4e\x79\x03\x6c\x2f\x00\xc1\xa8\xef\xe9\x0a\x4d\x9f\xab\x1d"
            "\xa1\x43\x0d\xc9\xaa\xe0\xef\xab\xcc\x5a\xe2\xd9\x12\x0e\x78\x60"
            "\x27\x72\x3d\x48\x70\x6a\x6d\x01\x08\x6f\x5e\x82\x21\x14\xc1\xb8"
            "\x26\x5c\xe0\xd4\xa9\x47\x64\x7a\xb2\xec\x3d\xe3\x7b\x1e\xfc\xcd"
            "\xc4\x94\xee\x42\x8e\xbb\xc7\xf9\xb4\x05\xf5\x8c\x2d\xfe\xb1\x3a"
            "\x00\x00\xa1\x80\x30\x82\x01\x27\x30\x81\x91\x30\x0d\x06\x09\x2a"
            "\x86\x48\x86\xf7\x0d\x01\x01\x02\x05\x00\x30\x62\x31\x11\x30\x0f"
            "\x06\x03\x55\x04\x07\x13\x08\x49\x6e\x74\x65\x72\x6e\x65\x74\x31"
            "\x17\x30\x15\x06\x03\x55\x04\x0a\x13\x0e\x56\x65\x72\x69\x53\x69"
            "\x67\x6e\x2c\x20\x49\x6e\x63\x2e\x31\x34\x30\x32\x06\x03\x55\x04"
            "\x0b\x13\x2b\x56\x65\x72\x69\x53\x69\x67\x6e\x20\x43\x6c\x61\x73"
            "\x73\x20\x31\x20\x43\x41\x20\x2d\x20\x49\x6e\x64\x69\x76\x69\x64"
            "\x75\x61\x6c\x20\x53\x75\x62\x73\x63\x72\x69\x62\x65\x72\x17\x0d"
            "\x39\x36\x30\x37\x30\x31\x31\x37\x33\x30\x34\x30\x5a\x17\x0d\x39"
            "\x37\x30\x37\x30\x31\x30\x30\x30\x30\x30\x30\x5a\x30\x0d\x06\x09"
            "\x2a\x86\x48\x86\xf7\x0d\x01\x01\x02\x05\x00\x03\x81\x81\x00\x18"
            "\xbb\x90\xe8\xf5\xfc\x03\xb0\x22\xa8\x11\x2d\x5b\x36\x2d\x97\xa9"
            "\x59\x35\x20\xc8\xd1\xb4\x79\x61\x4a\x3e\x0f\x62\x73\x93\x0d\xf4"
            "\x77\x14\x27\x25\x26\xca\x5c\x47\x3a\x5d\x8b\xb3\x01\x6e\x47\xbe"
            "\xbc\xc0\x4d\x7b\xb9\x73\x5f\x56\x58\xf4\xf8\x71\x10\xf0\x9a\x31"
            "\xfb\xd6\x2f\x50\x70\x3c\xac\x5b\x07\xff\xc0\x4d\x2a\x19\x38\x96"
            "\x23\x7b\x50\x4f\x42\x39\x54\x68\x7b\x8c\x82\x43\xd3\xb9\xe5\x07"
            "\x0d\xd1\xe1\x79\x7c\x74\x7f\x64\xaf\xce\x49\xb1\x68\xa7\xa8\x31"
            "\xf9\x60\xaa\x48\xa3\xda\x3c\x92\x76\x39\x9f\xbf\xaa\x8c\xea\x30"
            "\x82\x01\x24\x30\x81\x8e\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d"
            "\x01\x01\x02\x05\x00\x30\x5f\x31\x0b\x30\x09\x06\x03\x55\x04\x06"
            "\x13\x02\x55\x53\x31\x17\x30\x15\x06\x03\x55\x04\x0a\x13\x0e\x56"
            "\x65\x72\x69\x53\x69\x67\x6e\x2c\x20\x49\x6e\x63\x2e\x31\x37\x30"
            "\x35\x06\x03\x55\x04\x0b\x13\x2e\x43\x6c\x61\x73\x73\x20\x31\x20"
            "\x50\x75\x62\x6c\x69\x63\x20\x50\x72\x69\x6d\x61\x72\x79\x20\x43"
            "\x65\x72\x74\x69\x66\x69\x63\x61\x74\x69\x6f\x6e\x20\x41\x75\x74"
            "\x68\x6f\x72\x69\x74\x79\x17\x0d\x39\x36\x30\x37\x31\x36\x32\x33"
            "\x31\x31\x32\x39\x5a\x17\x0d\x39\x36\x30\x38\x31\x35\x30\x30\x30"
            "\x30\x30\x30\x5a\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01"
            "\x02\x05\x00\x03\x81\x81\x00\x17\xb0\xb1\x38\xbe\x7b\x18\xea\xc6"
            "\x3a\xed\x0a\xe6\x59\xe7\x3b\x89\xa5\x36\x7a\x1c\xf1\x6a\x71\x0a"
            "\xff\xdc\x0a\x1d\x93\x6e\x86\x53\x73\x93\xea\x86\x65\x9c\x36\x7a"
            "\xfc\x5f\x51\xed\x8e\x69\x16\xd8\xa6\x5f\x33\xb9\x9b\xe1\x2b\xd0"
            "\x47\x0f\x76\x9d\xd7\x83\x92\x7b\xdf\xf3\xc7\x98\x4e\x3e\x03\xff"
            "\x0d\x05\xed\xe9\x1e\x11\xf1\x0f\xf5\x26\x17\x81\xae\x89\x6b\x81"
            "\xb6\xaf\x8e\xf2\x36\xc0\xa4\xbc\xfc\xfb\x29\xda\x9a\xc1\xae\x41"
            "\x78\x4f\x8f\x3e\x00\xa4\x66\x4b\xc6\x73\x87\x58\x2e\xc6\x0b\xcf"
            "\x6f\xec\x52\xbb\xf8\xc7\xd2\x00\x00\x31\x80\x00\x00\x00\x00\x00"
            "\x00\x00\x00";

    AVS_LIST(avs_crypto_trusted_cert_info_t) certs = NULL;
    AVS_LIST(avs_crypto_cert_revocation_list_info_t) crls = NULL;
    AVS_UNIT_ASSERT_SUCCESS(avs_crypto_parse_pkcs7_certs_only(
            &certs, &crls, PKCS7_DATA, sizeof(PKCS7_DATA) - 1));

    AVS_UNIT_ASSERT_EQUAL(AVS_LIST_SIZE(certs), 2);

    avs_crypto_trusted_cert_info_t *cert1 = AVS_LIST_NTH(certs, 0);
    AVS_UNIT_ASSERT_EQUAL(cert1->desc.type,
                          AVS_CRYPTO_SECURITY_INFO_TRUSTED_CERT);
    AVS_UNIT_ASSERT_EQUAL(cert1->desc.source, AVS_CRYPTO_DATA_SOURCE_BUFFER);
    AVS_UNIT_ASSERT_EQUAL(cert1->desc.info.buffer.buffer_size, 1276);

    avs_crypto_trusted_cert_info_t *cert2 = AVS_LIST_NTH(certs, 1);
    AVS_UNIT_ASSERT_EQUAL(cert2->desc.type,
                          AVS_CRYPTO_SECURITY_INFO_TRUSTED_CERT);
    AVS_UNIT_ASSERT_EQUAL(cert2->desc.source, AVS_CRYPTO_DATA_SOURCE_BUFFER);
    AVS_UNIT_ASSERT_EQUAL(cert2->desc.info.buffer.buffer_size, 637);

    AVS_UNIT_ASSERT_EQUAL(AVS_LIST_SIZE(crls), 2);

    avs_crypto_cert_revocation_list_info_t *crl1 = AVS_LIST_NTH(crls, 0);
    AVS_UNIT_ASSERT_EQUAL(crl1->desc.type,
                          AVS_CRYPTO_SECURITY_INFO_CERT_REVOCATION_LIST);
    AVS_UNIT_ASSERT_EQUAL(crl1->desc.source, AVS_CRYPTO_DATA_SOURCE_BUFFER);
    AVS_UNIT_ASSERT_EQUAL(crl1->desc.info.buffer.buffer_size, 299);

    avs_crypto_cert_revocation_list_info_t *crl2 = AVS_LIST_NTH(crls, 1);
    AVS_UNIT_ASSERT_EQUAL(crl2->desc.type,
                          AVS_CRYPTO_SECURITY_INFO_CERT_REVOCATION_LIST);
    AVS_UNIT_ASSERT_EQUAL(crl2->desc.source, AVS_CRYPTO_DATA_SOURCE_BUFFER);
    AVS_UNIT_ASSERT_EQUAL(crl2->desc.info.buffer.buffer_size, 296);

    // Now let's check if it's loadable
    avs_crypto_trusted_cert_info_t cert_info =
            avs_crypto_trusted_cert_info_from_list(certs);
    avs_crypto_cert_revocation_list_info_t crl_info =
            avs_crypto_cert_revocation_list_info_from_list(crls);
    assert_trust_store_loadable(&cert_info, &crl_info);

    AVS_LIST_CLEAR(&certs);
    AVS_LIST_CLEAR(&crls);
}

AVS_UNIT_TEST(avs_crypto_pki_pkcs7, pkcs7_parse_failure) {
    // Converted to raw BER bytes and downloaded from:
    // https://raw.githubusercontent.com/openssl/openssl/dd0164e7565bb14fac193aea4c2c37714bf66d56/test/pkcs7-1.pem
    // This file contains encapsulated data and signerInfos
    static const char PKCS7_DATA[] =
            "\x30\x82\x02\x50\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x07\x02\xa0"
            "\x82\x02\x41\x30\x82\x02\x3d\x02\x01\x01\x31\x0e\x30\x0c\x06\x08"
            "\x2a\x86\x48\x86\xf7\x0d\x02\x02\x05\x00\x30\x28\x06\x09\x2a\x86"
            "\x48\x86\xf7\x0d\x01\x07\x01\xa0\x1b\x04\x19\x45\x76\x65\x72\x79"
            "\x6f\x6e\x65\x20\x67\x65\x74\x73\x20\x46\x72\x69\x64\x61\x79\x20"
            "\x6f\x66\x66\x2e\xa0\x82\x01\x5e\x30\x82\x01\x5a\x30\x82\x01\x04"
            "\x02\x04\x14\x00\x00\x29\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d"
            "\x01\x01\x02\x05\x00\x30\x2c\x31\x0b\x30\x09\x06\x03\x55\x04\x06"
            "\x13\x02\x55\x53\x31\x1d\x30\x1b\x06\x03\x55\x04\x0a\x13\x14\x45"
            "\x78\x61\x6d\x70\x6c\x65\x20\x4f\x72\x67\x61\x6e\x69\x7a\x61\x74"
            "\x69\x6f\x6e\x30\x1e\x17\x0d\x39\x32\x30\x39\x30\x39\x32\x32\x31"
            "\x38\x30\x36\x5a\x17\x0d\x39\x34\x30\x39\x30\x39\x32\x32\x31\x38"
            "\x30\x35\x5a\x30\x42\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02"
            "\x55\x53\x31\x1d\x30\x1b\x06\x03\x55\x04\x0a\x13\x14\x45\x78\x61"
            "\x6d\x70\x6c\x65\x20\x4f\x72\x67\x61\x6e\x69\x7a\x61\x74\x69\x6f"
            "\x6e\x31\x14\x30\x12\x06\x03\x55\x04\x03\x13\x0b\x54\x65\x73\x74"
            "\x20\x55\x73\x65\x72\x20\x31\x30\x5b\x30\x0d\x06\x09\x2a\x86\x48"
            "\x86\xf7\x0d\x01\x01\x01\x05\x00\x03\x4a\x00\x30\x47\x02\x40\x0a"
            "\x66\x79\x1d\xc6\x98\x81\x68\xde\x7a\xb7\x74\x19\xbb\x7f\xb0\xc0"
            "\x01\xc6\x27\x10\x27\x00\x75\x14\x29\x42\xe1\x9a\x8d\x8c\x51\xd0"
            "\x53\xb3\xe3\x78\x2a\x1d\xe5\xdc\x5a\xf4\xeb\xe9\x94\x68\x17\x01"
            "\x14\xa1\xdf\xe6\x7c\xdc\x9a\x9a\xf5\x5d\x65\x56\x20\xbb\xab\x02"
            "\x03\x01\x00\x01\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01"
            "\x02\x05\x00\x03\x41\x00\x45\x1a\xa1\xe1\xaa\x77\x20\x4a\x5f\xcd"
            "\xf5\x76\x06\x9d\x02\xf7\x32\xc2\x6f\x36\x7b\x0d\x57\x8a\x6e\x64"
            "\xf3\x9a\x91\x1f\x47\x95\xdf\x09\x94\x34\x05\x11\xa0\xd1\xdf\x4a"
            "\x20\xb2\x6a\x77\x4c\xca\xef\x75\xfc\x69\x2e\x54\xc2\xa1\x93\x7c"
            "\x07\x11\x26\x9d\x9b\x16\x31\x81\x9b\x30\x81\x98\x02\x01\x01\x30"
            "\x34\x30\x2c\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x55\x53"
            "\x31\x1d\x30\x1b\x06\x03\x55\x04\x0a\x13\x14\x45\x78\x61\x6d\x70"
            "\x6c\x65\x20\x4f\x72\x67\x61\x6e\x69\x7a\x61\x74\x69\x6f\x6e\x02"
            "\x04\x14\x00\x00\x29\x30\x0c\x06\x08\x2a\x86\x48\x86\xf7\x0d\x02"
            "\x02\x05\x00\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x01"
            "\x05\x00\x04\x40\x05\xfa\x6a\x81\x2f\xc7\xdf\x8b\xf4\xf2\x54\x25"
            "\x09\xe0\x3e\x84\x6e\x11\xb9\xc6\x20\xbe\x20\x09\xef\xb4\x40\xef"
            "\xbc\xc6\x69\x21\x69\x94\xac\x04\xf3\x41\xb5\x7d\x05\x20\x2d\x42"
            "\x8f\xb2\xa2\x7b\x5c\x77\xdf\xd9\xb1\x5b\xfc\x3d\x55\x93\x53\x50"
            "\x34\x10\xc1\xe1\xe1";

    AVS_LIST(avs_crypto_trusted_cert_info_t) certs = NULL;
    AVS_LIST(avs_crypto_cert_revocation_list_info_t) crls = NULL;
    // this file has a superfluous byte in it
    AVS_UNIT_ASSERT_FAILED(avs_crypto_parse_pkcs7_certs_only(
            &certs, &crls, PKCS7_DATA, sizeof(PKCS7_DATA) - 1));
    // but also contains encapsulated data and signerInfos
    AVS_UNIT_ASSERT_FAILED(avs_crypto_parse_pkcs7_certs_only(
            &certs, &crls, PKCS7_DATA, sizeof(PKCS7_DATA) - 2));
}
